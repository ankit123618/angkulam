<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .sidebar {
            height: 100vh;
            background-color: #343a40;
            color: #fff;
            padding-top: 20px;
        }

        .sidebar a {
            color: #fff;
        }

        .content {
            padding: 20px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-2 d-none d-md-block sidebar">
                <div class="sidebar-sticky">
                    <h4 class="text-center">Admin Panel</h4>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showSection('users')">
                                <i class="fas fa-users"></i> Users
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('books')">
                                <i class="fas fa-book"></i> Books
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('articles')">
                                <i class="fas fa-newspaper"></i> Articles
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4 content">
                <div id="users" class="section">
                    <h2>Users Management</h2>
                    <button class="btn btn-primary mb-3" onclick="showUserForm()">Add User</button>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- User data will be inserted here via JS -->
                        </tbody>
                    </table>
                    <div id="userForm" class="d-none">
                        <h3>Add/Edit User</h3>
                        <form id="userFormElement">
                            <input type="hidden" id="userId" name="id">
                            <div class="form-group">
                                <label for="username">Username</label>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                            <div class="form-group">
                                <label for="password">Password</label>
                                <input type="password" class="form-control" id="password" name="password">
                            </div>
                            <button type="submit" class="btn btn-success">Save</button>
                            <button type="button" class="btn btn-secondary" onclick="hideUserForm()">Cancel</button>
                        </form>
                    </div>
                </div>

                <div id="books" class="section d-none">
                    <h2>Books Management</h2>
                    <button class="btn btn-primary mb-3" onclick="showBookForm()">Add Book</button>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Subtitle</th>
                                <th>Price</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookTableBody">
                            <!-- Book data will be inserted here via JS -->
                        </tbody>
                    </table>
                    <div id="bookForm" class="d-none">
                        <h3>Add/Edit Book</h3>
                        <form id="bookFormElement">
                            <input type="hidden" id="bookId" name="id">
                            <div class="form-group">
                                <label for="bookTitle">Title</label>
                                <input type="text" class="form-control" id="bookTitle" name="title" required>
                            </div>
                            <div class="form-group">
                                <label for="bookSubtitle">Subtitle</label>
                                <input type="text" class="form-control" id="bookSubtitle" name="subtitle" required>
                            </div>
                            <div class="form-group">
                                <label for="bookPrice">Price</label>
                                <input type="number" step="0.01" class="form-control" id="bookPrice" name="price"
                                    required>
                            </div>
                            <div class="form-group">
                                <label for="bookImage">Image URL</label>
                                <input type="text" class="form-control" id="bookImage" name="image" required>
                            </div>
                            <button type="submit" class="btn btn-success">Save</button>
                            <button type="button" class="btn btn-secondary" onclick="hideBookForm()">Cancel</button>
                        </form>
                    </div>
                </div>

                <div id="articles" class="section d-none">
                    <h2>Articles Management</h2>
                    <button class="btn btn-primary mb-3" onclick="showArticleForm()">Add Article</button>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="articleTableBody">
                            <!-- Article data will be inserted here via JS -->
                        </tbody>
                    </table>
                    <div id="articleForm" class="d-none">
                        <h3>Add/Edit Article</h3>
                        <form id="articleFormElement">
                            <input type="hidden" id="articleId" name="id">
                            <div class="form-group">
                                <label for="articleTitle">Title</label>
                                <input type="text" class="form-control" id="articleTitle" name="title" required>
                            </div>
                            <div class="form-group">
                                <label for="articleContent">Content</label>
                                <textarea class="form-control" id="articleContent" name="content" rows="5"
                                    required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="articleImage">Image URL</label>
                                <input type="text" class="form-control" id="articleImage" name="image">
                            </div>
                            <button type="submit" class="btn btn-success">Save</button>
                            <button type="button" class="btn btn-secondary" onclick="hideArticleForm()">Cancel</button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showSection(section) {
            document.querySelectorAll('.section').forEach(el => el.classList.add('d-none'));
            document.getElementById(section).classList.remove('d-none');
        }

        function showUserForm() {
            document.getElementById('userForm').classList.remove('d-none');
        }

        function hideUserForm() {
            document.getElementById('userForm').classList.add('d-none');
        }

        function showBookForm() {
            document.getElementById('bookForm').classList.remove('d-none');
        }

        function hideBookForm() {
            document.getElementById('bookForm').classList.add('d-none');
        }

        function showArticleForm() {
            document.getElementById('articleForm').classList.remove('d-none');
        }

        function hideArticleForm() {
            document.getElementById('articleForm').classList.add('d-none');
        }

        function fetchData() {

            fetch('admin_api.php?type=users')
                .then(response => {
                    console.log("Response status:", response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    console.log(response.text());
                    return response.json();
                })
                .then(data => {
                    console.log("Fetched data:", data); // Log the fetched data

                    const userTableBody = document.getElementById('userTableBody');
                    userTableBody.innerHTML = ''; // Clear any existing content

                    data.forEach(user => {
                        console.log('Adding user to table:', user); // Log each user being added

                        userTableBody.innerHTML += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editUser(${user.id})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Delete</button>
                        </td>
                    </tr>`;
                    });
                })
                .catch(error => {
                    console.error('Error fetching users:', error);
                    document.getElementById('userTableBody').innerHTML = `<tr><td colspan="4">${error.message}</td></tr>`;
                });

            // Fetch Books
            fetch('admin_api.php?type=books')
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    const bookTableBody = document.getElementById('bookTableBody');
                    bookTableBody.innerHTML = '';
                    data.forEach(book => {
                        console.log(book);
                        bookTableBody.innerHTML += `
                            <tr>
                                <td>${book.id}</td>
                                <td>${book.title}</td>
                                <td>${book.subtitle}</td>
                                <td>${book.price}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm" onclick="editBook(${book.id})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteBook(${book.id})">Delete</button>
                                </td>
                            </tr>`;
                    });
                });

            // Fetch Articles
            fetch('admin_api.php?type=articles')
                .then(response => response.json())
                .then(data => {
                    const articleTableBody = document.getElementById('articleTableBody');
                    articleTableBody.innerHTML = '';
                    data.forEach(article => {
                        articleTableBody.innerHTML += `
                            <tr>
                                <td>${article.id}</td>
                                <td>${article.title}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm" onclick="editArticle(${article.id})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteArticle(${article.id})">Delete</button>
                                </td>
                            </tr>`;
                    });
                });
        }

        // Save user
        document.getElementById('userFormElement').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            console.log("form data: ", formData);
            fetch('admin_api.php', {
                method: 'POST',
                body: formData
            }).then(response => response.json())
                .then(data => {
                    alert(data.message || data.error);
                    fetchData();
                    hideUserForm();
                });
        });

        // Save book
        document.getElementById('bookFormElement').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('admin_api.php', {
                method: 'POST',
                body: formData
            }).then(response => response.json())
                .then(data => {
                    alert(data.message || data.error);
                    fetchData();
                    hideBookForm();
                });
        });

        // Save article
        document.getElementById('articleFormElement').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('admin_api.php', {
                method: 'POST',
                body: formData
            }).then(response => response.json())
                .then(data => {
                    alert(data.message || data.error);
                    fetchData();
                    hideArticleForm();
                });
        });

        // Edit user
        function editUser(id) {
            fetch(`admin_api.php?type=user&id=${id}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('userId').value = data.id;
                    document.getElementById('username').value = data.username;
                    document.getElementById('email').value = data.email;
                    document.getElementById('password').value = ''; // Do not prefill password
                    showUserForm();
                });
        }

        // Delete user
        function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user?')) {
                fetch('admin_api.php', {
                    method: 'DELETE',
                    body: JSON.stringify({ type: 'user', id: id })
                }).then(response => response.json())
                    .then(data => {
                        alert(data.message || data.error);
                        fetchData();
                    });
            }
        }

        // Similar functions for books and articles
        function editBook(id) {
            fetch(`admin_api.php?type=book&id=${id}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('bookId').value = data.id;
                    document.getElementById('bookTitle').value = data.title;
                    document.getElementById('bookSubtitle').value = data.subtitle;
                    document.getElementById('bookPrice').value = data.price;
                    document.getElementById('bookImage').value = data.image;
                    showBookForm();
                });
        }

        function deleteBook(id) {
            if (confirm('Are you sure you want to delete this book?')) {
                fetch('admin_api.php', {
                    method: 'DELETE',
                    body: JSON.stringify({ type: 'book', id: id })
                }).then(response => response.json())
                    .then(data => {
                        alert(data.message || data.error);
                        fetchData();
                    });
            }
        }

        function editArticle(id) {
            fetch(`admin_api.php?type=article&id=${id}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('articleId').value = data.id;
                    document.getElementById('articleTitle').value = data.title;
                    document.getElementById('articleContent').value = data.content;
                    document.getElementById('articleImage').value = data.image;
                    showArticleForm();
                });
        }

        function deleteArticle(id) {
            if (confirm('Are you sure you want to delete this article?')) {
                fetch('admin_api.php', {
                    method: 'DELETE',
                    body: JSON.stringify({ type: 'article', id: id })
                }).then(response => response.json())
                    .then(data => {
                        alert(data.message || data.error);
                        fetchData();
                    });
            }
        }

        // Initial data fetch
        fetchData();
    </script>
</body>

</html>